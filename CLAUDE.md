# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What is mtcute?

mtcute is a TypeScript MTProto (Telegram API) library supporting Node.js, Bun, Deno, and browsers. Monorepo with pnpm workspaces.

## Commands

```bash
# Install
pnpm install --frozen-lockfile

# Generate TL schema code (required after clone)
pnpm -C packages/tl run gen-code

# Test
pnpm test                              # all tests
pnpm test -- packages/core             # tests in one package
pnpm test -- --testPathPattern=foo     # filter by name

# Lint
pnpm lint                              # eslint
pnpm lint:tsc                          # typecheck all packages
pnpm lint:fix                          # eslint --fix

# Build a package (from package dir)
pnpm exec fuman-build vite

# Generate TelegramClient class from methods
node packages/core/scripts/generate-client.cjs

# Generate update types for dispatcher
node packages/dispatcher/scripts/generate.cjs
```

## Package overview

| Package | Purpose |
|---------|---------|
| `core` | MTProto client, high-level API methods, types, storage |
| `tl` | TL schema definitions, codegen from schema JSON |
| `tl-runtime` | TL binary serialization/deserialization |
| `tl-utils` | TL schema parsing, codegen utilities |
| `node` | Node.js platform bindings (crypto, sqlite, transport) |
| `bun` | Bun platform bindings |
| `deno` | Deno platform bindings |
| `web` | Browser platform bindings (IndexedDB, WebCrypto) |
| `dispatcher` | Updates routing, filters, bot framework |
| `html-parser` | HTML ↔ Telegram entities |
| `markdown-parser` | Markdown ↔ Telegram entities |
| `file-id` | Telegram Bot API file_id parsing/serialization |
| `convert` | Session conversion from other libraries |
| `test` | Test utilities, stub client for unit tests |
| `wasm` | WASM crypto implementations |
| `create-bot` | Scaffolding CLI |
| `i18n` | Internationalization |

## TL types naming scheme

In the `tl` namespace, types are named after their TL object name:
- Objects (like `_: 'user'`) are named `tl.RawUser`
- Namespaces (like `_: 'messages.chats'`) are named `tl.messages.RawChats`
- Methods (like `_: 'users.getUsers'`) are named `tl.users.RawGetUsersRequest`
- Unions are named with Type prefix: `tl.TypeUser = tl.RawUser | tl.RawUserEmpty`

## Architecture

### Client layers

1. **`BaseTelegramClient`** (`core/src/highlevel/base.ts`) — low-level client handling connection, RPC calls, updates manager
2. **Method functions** (`core/src/highlevel/methods/`) — standalone functions taking `ITelegramClient` as first arg
3. **`TelegramClient`** (`core/src/highlevel/client.ts`) — **auto-generated** class wrapping method functions as class methods. Generated by `packages/core/scripts/generate-client.cjs`
4. **`ITelegramClient`** (`core/src/highlevel/client.types.ts`) — interface describing the client contract

### Method codegen system

Files in `core/src/highlevel/methods/` use magic comment annotations processed by `generate-client.cjs`:
- `// @copy` — copy import/block to generated client.ts
- `// @extension` — add interface fields to TelegramClient class
- `// @initialize` — copy function body to constructor
- `// @exported` — re-export type from client module

Shared imports for the codegen live in `methods/_imports.ts`. After adding/modifying methods, run `node packages/core/scripts/generate-client.cjs`.

Auto-generated files (do not edit or read yourself):
- `packages/core/src/highlevel/client.ts`
- `packages/core/src/highlevel/methods.ts`

### Platform abstraction

Platform packages (`node`, `bun`, `deno`, `web`) provide `ICorePlatform` implementations (crypto, transport, storage). They re-export a `TelegramClient` that pre-configures platform bindings.

### TL schema

`packages/tl` contains the Telegram TL schema (`api-schema.json`) and generated TypeScript types/readers/writers. The `tl` namespace provides typed constructors and methods. Version follows TL layer number (e.g., `222.0.0`).

## Code style

- ESM throughout, `"type": "module"` in all packages
- Single quotes, no semicolons (antfu eslint config)
- 120 char line limit
- 1tbs brace style
- `isolatedDeclarations: true` — all exports need explicit return types
- Import paths use `.js` extension
- Tests colocated as `*.test.ts` next to source files
- Use `@fuman/utils` for common utilities (not lodash etc.)
- Globals `Buffer`, `__dirname`, `require`, `NodeJS`, `setTimeout`, `clearTimeout` are restricted via eslint — use platform-agnostic alternatives

## Testing

Uses vitest. Config at `.config/vite.ts`. Test utilities in `packages/test` — provides `StubTelegramClient` for mocking RPC calls without network.
