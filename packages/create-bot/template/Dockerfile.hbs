{{emit_if features.docker}}
FROM node:22-alpine AS build
WORKDIR /build

RUN apk add python3 make g++ && \
    corepack enable && \
    corepack prepare pnpm@8.7.1 --activate

COPY package*.json pnpm*.yaml {{#if features.typescript}}tsconfig.json{{/if}} ./
RUN pnpm install --frozen-lockfile

COPY src ./src
RUN pnpm run build
RUN pnpm prune --prod

FROM node:22-alpine
WORKDIR /app
COPY --from=build /build/package*.json ./
COPY --from=build /build/dist ./dist
COPY --from=build /build/node_modules ./node_modules

ENTRYPOINT [ "docker-entrypoint.sh", "node", "/app/dist/main.js" ]
